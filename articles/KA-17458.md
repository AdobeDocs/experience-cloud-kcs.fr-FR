---
title: Optimisation de la variable [!DNL Dispatcher] cache
description: Description
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/20/2021 7:12:29 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 1:45:44 PM
version-number: 1
article-number: KA-17458
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ee6e74a7-d931-ec11-b6e5-000d3a5ba97a
exl-id: 84871fce-d53d-4a1d-aabf-ccf8c8c47810
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1411'
ht-degree: 2%

---

# Optimisation de la variable [!DNL Dispatcher] cache

## Description


Cet article se concentre sur les dernières optimisations du Dispatcher AEM et sur la manière de les exploiter au mieux.  Dispatcher AEM est une mise en cache [proxy inverse](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server) serveur conçu pour être utilisé avec Adobe Experience Manager.  Il peut être installé et exécuté en tant que module dans les logiciels de serveur web existants.  Au moment de la rédaction du présent article, le [Le module dispatcher est pris en charge](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-install.html) on [!DNL Apache HTTP Server], Microsoft IIS et [!DNL iPlanet].


## Résolution

<br><br>Fonctionnement de la mise en cache de Dispatcher<br><br><br><br><br><br>
Au niveau le plus élémentaire, le Dispatcher AEM est un proxy inverse qui fonctionne en exécutant la mise en cache, le vidage du cache et l’invalidation du cache.

Pour plus d’informations sur Dispatcher, voir les liens connexes :

1. [Fonctionnement du Dispatcher et procédure d’installation](https://helpx.adobe.com/fr/experience-manager/dispatcher/using/dispatcher.html).
2. [Options de configuration disponibles dans le Dispatcher](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html).
3. [Webinaire sur le fonctionnement du Dispatcher](https://github.com/cqsupport/webinar-dispatchercache) - notez que certaines informations de la présentation sont basées sur les anciennes versions du dispatcher.
4. [Session de webinaire Gems sur les fonctionnalités de Dispatcher, l’utilisation du réseau de diffusion de contenu et la sécurité](https://docs.adobe.com/ddc/en/gems/dispatcher-caching---new-features-and-optimizations.html).
5. [Session Gems sur les nouvelles fonctionnalités de Dispatcher (version ultérieure à la version 4.1.9)](https://helpx.adobe.com/experience-manager/kt/eseminars/gems/aem-dispatcher.html).

<br><br><br><br><br><br>Optimisation du cache de Dispatcher<br><br><br><br><br><br>
Voici quelques façons d’optimiser le cache du dispatcher :

1. <b>Cache presque tout</b> - cela signifie mettre en cache tout contenu qui serait demandé plus d’une fois par les utilisateurs.
2. <b>Mise en cache du contenu personnalisé pour différentes périodes</b> - Si votre site comporte du contenu personnalisé, envisagez d’utiliser [[!DNL Apache Sling Dynamic Includes]](https://helpx.adobe.com/experience-manager/kt/platform-repository/using/sling-dynamic-include-technical-video-setup.html) dans votre application AEM pour tirer parti de [!DNL Ajax] (Appels JavaScript et XML asynchrones au niveau du navigateur), SSI (Server Side Includes au niveau du serveur web) et ESI (Edge-side Includes au niveau du CDN) pour mettre en cache différentes parties de la page pendant différentes périodes.
3. <b>Ne jamais supprimer le cache du Dispatcher sur un Dispatcher en direct</b> - Si un Dispatcher diffuse du contenu en direct et que vous supprimez le cache, cela provoquera un flot massif de demandes de retour à AEM.  En conséquence, le cache du Dispatcher ne doit jamais être supprimé sur un Dispatcher actif.
4. <b>Blocage du cache </b>- Avant de supprimer la variable [!DNL Dispatcher] cache, extrayez le [!DNL Dispatcher] de votre équilibreur de charge, supprimez le cache, puis exécutez un outil de moteur de recherche Web pour mettre en cache les fichiers sur le dispatcher avant de le placer sur l’équilibreur de charge.
5. <b>Pages d’erreur de cache</b> - Tirez parti des <b>[DispatcherPassError 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer) </b>([!DNL Apache] Spécifique au serveur web) pour traiter les pages d’erreur, telles que les 404 du cache du Dispatcher.
6. <b>GZip compresse tous les types de fichiers à l’exception de ceux qui sont pré-compressés. </b>- Dans [!DNL Apache] Web Server, [mod_deflate](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html) peut être utilisé, mais assurez-vous que la variable <b>`Vary: User-Agent` </b>header<b> </b>n’est pas définie.  Dans Microsoft IIS, utilisez [Compression dynamique](https://docs.microsoft.com/en-us/iis/configuration/system.webserver/httpcompression/).

   [!DNL Apache] exemple de configuration (en spécifiant uniquement certains types de contenu pour éviter les types de fichiers précompressés) :

   `AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript`
7. <b>Activer [/serveStaleOnError](https://helpx.adobe.com/experience-manager/kb/ServeStaleContentOnError.html)</b> dans le `/cache` configuration : diffusez l’ancien fichier cache lorsque les instances AEM diffusent des erreurs.
8. <b>Ajouter [/gracePeriod](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> au `/cache` configuration : définissez le nombre de secondes pendant lesquelles une ressource obsolète et invalidée automatiquement peut toujours être diffusée à partir du cache après le dernier événement de publication de contenu (&quot;activation&quot;).  Cela réduit le nombre de requêtes qui reviennent aux instances de publication lors d’une activité de publication de contenu importante, telle qu’une &quot;Activation d’arborescence&quot;.
9. <b>Ajouter des règles à [/ignoreUrlParams](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters)</b> - ignore les paramètres de chaîne de requête qui ne sont pas requis ou utilisés par l’application.  Cela permet la mise en cache des URL même lorsqu’une chaîne de requête est présente.
10. <b>Mise en cache des en-têtes de réponse Cache-Control et Last-Modified</b> - Utilisez la variable<b> [/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> configuration pour mettre en cache les en-têtes de réponse HTTP <b>`Cache-Control`</b> et <b>`Last-Modified` </b>(et/ou <b>`ETag`</b> en-tête si vous l’envoyez à partir d’AEM).  Cela permet de simplifier et d’optimiser la mise en cache au niveau du réseau de diffusion de contenu et du navigateur.  La mise en cache de ces en-têtes permet d’AEM uniquement de définir les en-têtes, et non le serveur web lui-même.  Notez que lorsque vous procédez de la sorte, vous devez commencer à envoyer les en-têtes à partir de votre application AEM.
11. <b>Mettre en cache le contenu aussi longtemps que possible</b> et <b>réduire les demandes qui reviennent à AEM</b> - Optimisez les requêtes de purge en activant [refetching](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#refetching-flush) videz tous les agents de vidage.  Ou utilisez [<b>/enableTTL</b>](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) et défini <b>`Cache-Control: max-age=...`</b> pour mettre en cache les fichiers aussi longtemps que possible.  Voir [below](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) pour plus d’informations sur cette rubrique.

<br><br><br><br><br><br>Utilisation de TTL<br><br><br><br><br><br>
À partir de [!DNL Dispatcher] version 4.1.11, [/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL) peut être défini dans la variable `.any` configuration des fichiers.  Ce paramètre permet au dispatcher de respecter les expirations du cache définies dans le HTTP. `Cache-Control` en-tête de la réponse.  En d’autres termes, Dispatcher fonctionnera comme un réseau de diffusion de contenu où une Principale forme d’invalidation du cache se produit lorsque les fichiers expirent.  Une fois que vous avez implémenté ceci et que vous avez commencé à envoyer <b>`Cache-Control: max-age=...` </b>pour toutes les réponses d’AEM, vous pouvez désactiver en toute sécurité vos agents de vidage du dispatcher dans les instances de publication.

Après avoir désactivé les agents de vidage sur les instances de publication, vous pouvez toujours être en mesure de vider le cache du dispatcher.  Dans ce cas, vous pouvez utiliser [ACS Commons - Interface utilisateur de vidage de Dispatcher](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html).  Cet outil est installé sur l’instance de création.  Il fournit aux utilisateurs une interface utilisateur dans laquelle ils peuvent exécuter des requêtes de vidage de cache manuelles.

<b>I. Étapes pour activer les invalidations de style TTL (&quot;Time to Live&quot; ou expiration) :</b>

1. Modifier le code source dans l’application AEM à envoyer <b>`Cache-Control` </b>header et <b>`Last-Modified` </b>pour toutes les requêtes pour lesquelles elle n’est pas déjà définie.
2. Installer [!DNL Dispatcher] 4.1.11 ou version ultérieure.
3. Définir <b>[/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> dans le `.any` configuration de la ferme du site.
4. Définissez la variable <b>[/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>configuration pour mettre en cache la variable <b>`Cache-Control`</b> et <b>`Last-Modified`</b> en-têtes.
5. Redémarrez le serveur web.


<b>II. Désactivez les agents de vidage du dispatcher sur les instances de publication :</b>

Le Dispatcher utilise désormais le `Cache-Control` pour contrôler l’invalidation des fichiers de cache.  Comme c’est le cas, la purge du dispatcher à partir des instances de publication n’est plus nécessaire.

1. Accédez à `/etc/replication/agents.publish.html` sur chaque instance de publication.
2. Accédez à la configuration de chaque agent de purge et désactivez l’agent.


<b>III. Autoriser les demandes de vidage manuelles du dispatcher à partir de l’instance d’auteur :</b>

Maintenant que les agents de vidage sont désactivés, vous pouvez vous reposer entièrement sur la variable <b>`Cache-Control` </b>en-tête pour contrôler le moment où le contenu est actualisé sur le Dispatcher.  Vous pouvez toujours permettre aux utilisateurs d’émettre des vidages manuels du cache du Dispatcher :

1. Installer [ACS Commons - Interface utilisateur de vidage de Dispatcher](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html) sur l’instance d’auteur.
2. Configurez les agents de purge sur l’instance d’auteur.
3. Dans chacune des configurations de l’agent, définissez <b>Triggers</b> = <b>Ignorer la valeur par défaut </b>pour activer. Cette option rend les agents de vidage ignorés lorsque les utilisateurs cliquent <b>(Un)Publier </b>ou <b>(De) Activer</b> dans l’interface utilisateur d’AEM.

<br><br><br><br><br><br>Récupération du vidage de Dispatcher<br><br><br><br><br><br>
Pour optimiser les requêtes de vidage du répartiteur, tous les agents de vidage du répartiteur doivent avoir une fonctionnalité appelée vidage de récupération activée.

Pour activer la récupération du vidage du répartiteur, procédez comme suit :

1. Accédez à <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> et connectez-vous en tant qu’administrateur.
2. Téléchargez le module depuis [here](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true).
3. Téléchargez et installez le package dans le gestionnaire de packages.
4. Accédez à la configuration de l’agent de vidage du dispatcher. Par exemple <b>/etc/replication/agents.author/flush.html</b>
5. Cliquez sur <b>[!UICONTROL Modifier]</b>
6. Définissez les
   - <b>Type de sérialisation</b> = <b>Récupérer le vidage du Dispatcher</b>
   - <b>Étendu</b> = <b>Méthode HTTP</b> = <b>POST</b>
7. Cliquez sur <b>[!UICONTROL Enregistrer]</b>


Notez que le package installé ci-dessus n’est qu’un exemple de base.  Pour personnaliser et optimiser le vidage de récupération, vous pouvez modifier la liste des URI qu’il envoie.  Le code est open source et se trouve [here](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle).  Le code ajoute une liste d’URI au corps de la requête en tant que paramètres indiquant au dispatcher les chemins à récupérer.  Vous pouvez ajouter d’autres chemins en fonction des exigences de votre application afin d’optimiser les fonctionnalités de mise en cache de votre site.
<br><br><br><br><br><br>Une explication plus détaillée de la récupération du vidage<br><br><br><br><br><br>
Normalement, un vidage du dispatcher fonctionne en supprimant des fichiers :

1. Touche `.stat` fichier(s)
2. Supprimer `/content/foo.\*`
3. Supprimer `/content/foo/_jcr_content`


En raison du fait que les fichiers sont supprimés à l’étape 2, la prochaine fois qu’un utilisateur demande un fichier comme `/content/foo.html` ou `/content/foo.json`, tandis que le fichier est &quot;récupéré à nouveau&quot;, les demandes suivantes pour le même fichier sont également envoyées aux instances de publication jusqu’à ce que le fichier soit mis en cache.  Pour les réponses lentes ou les pages à trafic élevé, telles que les pages d’accueil, cela peut entraîner une inondation du niveau de l’instance de publication.

Pour résoudre ce problème, activez une fonctionnalité du Dispatcher appelée récupération à nouveau.  Cette fonctionnalité vous permet d’envoyer une liste d’URI que le Dispatcher doit &quot;récupérer&quot; de manière proactive et remplacer plutôt que de supprimer.

Voir 22:41-27:05 in this [enregistrement de présentation](https://my.adobeconnect.com/p7th2gf8k43) pour une démonstration de son fonctionnement et de sa configuration.
