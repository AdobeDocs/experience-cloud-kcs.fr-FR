---
title: Migration d’utilisateurs, de groupes et de listes de contrôle d’accès entre AEM instances
description: Description
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: af761579c3fb5e51cf5f4d144bff0e058fd13911
workflow-type: tm+mt
source-wordcount: '960'
ht-degree: 1%

---

# Migration d’utilisateurs, de groupes et de listes de contrôle d’accès entre AEM instances

## Description

Comment migrer des utilisateurs et des groupes avec des autorisations ACL dans AEM d’un serveur à un autre ou d’une instance AEM à une autre.

## Résolution

**Étape 1 : Rechercher les administrateurs et les utilisateurs anonymes**

1. Accédez à l’application CRXDE lite `/crx/de/index.jsp` et connectez-vous en tant qu’utilisateur administrateur (sur le système source).
1. Accédez à &quot;Outils&quot; = &quot;Requête&quot;.
1. Dans la zone &quot;Requête&quot; inférieure, saisissez cette requête pour trouver l’utilisateur administrateur : *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. Cliquez sur &quot;Exécuter&quot; et copiez le chemin d’accès du noeud utilisateur admin dans les résultats dans un fichier texte.
1. Répétez l’étape 3 avec une requête pour l’utilisateur anonyme : *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. Cliquez sur &quot;Exécuter&quot; et copiez le chemin d’accès du noeud utilisateur anonyme dans les résultats dans un fichier texte (vous disposez donc de deux chemins d’accès, l’un pour &quot;admin&quot; et l’autre pour &quot;anonymous&quot;).

   Par exemple :

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` - utilisateur administrateur sur le système source

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` - utilisateur anonyme sur le système source

**Étape 2A : Migration des utilisateurs et des groupes (à l’aide de `crx2oak` ou `oak-upgrade`)**

Les utilisateurs et les groupes peuvent être migrés entre les instances d’AEM à l’aide du [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) ou [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) outils .

1. Téléchargez la `crx2oak` ou `oak-upgrade` jar correspondant à la version Oak que vous utilisez : 
   1. Oak-upgrade : [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak : [Référentiel Maven](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. Téléchargez le fichier jar sur le serveur AEM
1. Arrêter les AEM (instances source et de destination)
1. Remplacez le nom du fichier jar dans la commande ci-dessous.
1. Remplacer *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`* dans le *`--exclude-paths`* du paramètre part de la commande ci-dessous avec les chemins d’accès des utilisateurs admin et anonyme de votre système source.
1. Modifiez les chemins en ligne pour qu&#39;ils correspondent à votre instance (ajoutez *`segment-old:`* avant le chemin, le cas échéant, voir ici [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)) : *`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. Exécutez ensuite la commande sur le shell du serveur.

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. Une fois l’opération terminée, passez à l’étape 3 pour migrer les listes de contrôle d’accès.  Si vous ne parvenez pas à migrer à l’aide de la variable `crx2oak` suivez plutôt les étapes de migration des packages ci-dessous.

**Étape 2B : migration des utilisateurs et des groupes (à l’aide de packages)**

Si les utilisateurs ne sont pas importés automatiquement via l&#39;authentification LDAP/SAML ou `CRX2Oak` (méthode A ci-dessus) vous pouvez ensuite regrouper des utilisateurs et des groupes.  Dans ce cas, vous créez deux packages distincts sur l’ancien système (à l’exclusion des administrateurs et des utilisateurs anonymes prêts à l’emploi).

1. Copiez le chemin d’accès des noeuds utilisateur anonyme et administrateur à partir des résultats de l’ étape 1 (&quot;Trouver les utilisateurs administrateur et anonyme&quot;) ci-dessus.

   Par exemple :

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` - utilisateur administrateur sur le système sur lequel je crée le module

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` - utilisateur anonyme sur le système sur lequel je crée le package

1. Accédez au &quot;Gestionnaire de modules&quot;, *`http://host:port/crx/packmgr/index.jsp`* et connectez-vous en tant qu’administrateur.
1. Créer un package &quot;utilisateurs&quot;
1. Ajoutez un filtre à la configuration du module pour `/home/users` avec ces règles d’exclusion (sur la `/home/users` filter) :
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. Créez le module.
1. Téléchargez le package.
1. Décompressez le fichier zip du package sur votre ordinateur : `jar -xvf users.zip META-INF/vault/filter.xml`
1. Ouvrir le fichier `META-INF/vault/filter.xml` dans un éditeur de texte.
1. Ajouter `mode="merge"` à la balise filter ... , par exemple :

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. Recompressez le contenu du module modifié pour qu’il inclue la modification.

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. Créer un package &quot;groupes&quot; contenant une règle de filtrage `/home/groups`.
1. Répétez les étapes 11 à 14 pour le package de groupes.
1. (Mise à niveau uniquement) Si vous effectuez une migration vers une nouvelle version d’AEM, installez une nouvelle instance d’AEM locale. *de l’ancienne version*(avec nosamplecontent), puis installez le module utilisateurs, puis le module groupes là-bas. Ensuite, effectuez une mise à niveau statique vers la nouvelle version sur cette instance. Les utilisateurs sont ainsi convertis en nouvelle représentation Oak. Après la mise à niveau statique, recompressez les utilisateurs pour les transférer à l’instance mise à niveau prévue. Faites de même pour les groupes d’utilisateurs.
1. Installez le package d’utilisateurs sur le nouveau système.
1. Installez le package de groupes sur le nouveau système.
1. Si vous migrez d’une ancienne AEM vers la version 6.3, accédez à la `/useradmin` et ajoutez le récepteur de réplication de l’utilisateur au groupe &quot;administrateurs&quot;.

**Étape 3. Migration des listes ACL**

Si vous pouvez installer des outils (ACS Commons) pour AEM, procédez comme suit :

1. Téléchargez et installez ACS Commons.
1. Suivez les étapes fournies ici pour créer un package ACL.
1. Accédez à http://aem-host:port/crx/packmgr/index.jsp and connectez-vous en tant qu’administrateur.
1. Cliquez sur le package ACL.
1. Cliquez sur Modifier.
1. Sélectionnez la [!UICONTROL Avancé] (voir capture d’écran ci-dessous).
1. Dans le menu déroulant Gestion de l’AC , sélectionnez [!UICONTROL Fusion] pour éviter de supprimer des listes de contrôle d’accès existantes sur le système de destination. Ceci est particulièrement important lors de la migration des listes de contrôle d’accès entre différentes versions d’AEM (car cela évite de supprimer les listes de contrôle d’accès prêtes à l’emploi).

Si vous êtes *not* Vous pouvez installer des outils (ACS Commons) pour AEM, puis suivre ces étapes. Notez que la machine sur laquelle vous exécutez ces commandes doit être Mac OS, [!DNL Linux]ou [!DNL Windows] (en utilisant [!DNL Cygwin]) avec cURL, [!DNL Python], et [!DNL Java] SDK installé.

1. Accédez à http://src-aem-host:port/crx/packmgr/index.jsp and connectez-vous en tant qu’administrateur.
1. Créez un package nommé &quot;ACL-migration&quot;.
1. Cliquez sur le bouton Modifier .
1. Sélectionnez la [!UICONTROL Avancé] et définissez le mode de gestion AC sur Fusionner.
1. Enregistrez.
1. Créez le package et téléchargez-le.
1. Sur le système de fichiers, exécutez cette commande sur le package pour extraire le `META-INF/vault/filter.xml` fichier : 

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. Dans le même répertoire, exécutez cette commande pour télécharger un fichier json des chemins d’accès ACL sous `/content` à partir de l’instance source (définissez le nom d’utilisateur et le mot de passe, puis corrigez l’hôte) : 

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. Création d’un fichier `generate-package-filter.py` et collez le [!DNL Python] code ci-dessous : 

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. Exécutez la variable [!DNL Python] script à partir du dossier dans lequel data.json a été créé et enregistrez la sortie dans `META-INF/vault/filter.xml` (remplacement du contenu existant de `filter.xml`) : 

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. Utilisez cette commande pour mettre à jour la variable `filter.xml` dans le fichier zip :

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. Téléchargez le fichier zip dans le gestionnaire de packages de l’instance source : http://src-aem-host:port/crx/packmgr/index.jsp
1. Cliquez sur [!UICONTROL Build] ou [!UICONTROL Reconstruire] pour créer le module.
1. Téléchargez le package à partir du serveur d’AEM source.
1. Téléchargez le package dans le gestionnaire de packages AEM serveur de destination : http://dst-aem-host:port/crx/packmgr/index.jsp
1. Cliquez sur [!UICONTROL Installer] pour l’installer.
1. Répétez les étapes 8 à 16 pour tous les autres chemins modifiant la commande curl du chemin. Par exemple, les listes de contrôle d’accès situées sous `/etc` au lieu de `/content`:

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
