---
title: "Erreur : Trop de fichiers ouverts"
description: Description
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '732'
ht-degree: 1%

---

# Erreur : Trop de fichiers ouverts

## Description

<br><br><br>Problème<br><br><br><br><br><br>
Les fichiers journaux contiennent l’erreur &quot;Trop de fichiers&quot; et AEM ne répond pas.
<br><br><br><br><br><br>Cause<br><br><br><br><br><br>
La cause est l&#39;une des deux possibilités :

- L’application ne ferme pas les ressources telles que les fichiers ou les sockets après les avoir utilisées.
- Ou l’application nécessite plus de fichiers ouverts que ce qui est autorisé par le processus.



## Résolution

<br><br> <br><br><br><br><br><br>
La solution à ce problème est la suivante :

1. Découvrez ce qui cause l’atteinte de la limite du fichier ouvert
2. Augmentez la limite ou corrigez les bogues de l’application.

<br><br><br><br>Rechercher les fichiers ou les sockets qui restent ouverts<br><br> <br><br>
\*\* Notez que les limites de fichiers ouverts s’appliquent au total des fichiers ouverts, des tuyaux et des sockets, et pas seulement aux fichiers.

Sur la plateforme Linux, la commande lsof peut être utilisée pour déboguer les ressources qui sont maintenues ouvertes par le processus.

Voici un exemple de script pour collecter des pertes de sortie utiles :
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6<br>  7<br>  8<br>  9<br>  10<br>  11<br>  12<br>  13<br>  14<br>  15<br>  16<br>  17<br>  18<br>  19<br>  20<br>  21 | `#!/bin/bash``if` `$``# -eq 0``  ``then``    ``echo` `"No PID specified"``    ``echo` `"Run command with PID, for example:"``    ``echo` `"lsof-script.sh 12345"``    ``exit` `2``fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID``lsof``-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt | ``wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt |``awk` `'{print $9}'` `|``sed` `-e``"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(repository/index\).*$/\1\2/"` `|``sed` `-e``"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/lib\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/logs\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/ext\).*$/\1\2/"` `|``sort` `|``uniq` `-c |``sort` `-rn -k1``lsof``-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"``lsof` `|``wc` `-l` |
| --- | --- |

<br><br><br><br><br> <br><br>
Exemple de résultat:
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6 | `$ ./lsof-script.sh 18070``Files open by the process:``    ``1995``Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt``Total open files in OS:``   ``18399` |
| --- | --- |

<br><br><br><br><br> <br><br>
Inspect la sortie du fichier lsof-sorted-count-\*.txt généré.  Il indique les fichiers ou les sockets qui sont actuellement conservés ouverts par le processus.

Si vous trouvez des sockets ou des fichiers ouverts qui ne doivent pas encore être ouverts, cela est probablement dû à un bogue de l’application.  Mettez à jour le code de votre application pour fermer les fichiers et les sockets après les avoir utilisés.

Le code personnalisé qui crée un service Web est une cause courante de la persistance des sockets ouverts.  Dans de nombreux cas, des bibliothèques comme Apache Commons HttpClient sont utilisées, mais les connexions ne sont jamais fermées par les développeurs.  Voir [cet article](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) pour plus d’informations sur Apache Commons HttpClient.
<br><br><br><br> <br><br>Augmentation de la limite de la session shell<br><br><br><br> <br><br>
Vérifiez la limite de l’utilisateur pour le nombre maximal de fichiers ouverts, puis exécutez ce qui suit en tant que même utilisateur que le processus AEM s’exécute comme suit :

ulimit -Sn ulimit -Hn

Lors de l’utilisation du script de démarrage par défaut d’AEM/CQ, procédez comme suit pour augmenter la limite :

1. Ouvrez crx-quickstart/bin/start pour le modifier.
2. Ajoutez la variable CQ_MAX_OPEN_FILES en haut du script : CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES


Si l’erreur &quot;-bash: ulimit: Ouvrir les fichiers : Impossible de modifier la limite : Opération non autorisée&quot; lors du démarrage de l’AEM, la configuration ci-dessus ne fonctionne pas.

Au lieu de cela, il est nécessaire d’augmenter la limite dans /etc/security/limits.conf. Voir ci-dessous pour plus d’informations sur la reconfiguration de la limite utilisateur.

Si vous utilisez un serveur d’applications tiers tel que JBoss ou Websphere, suivez les sections ci-dessous et vérifiez la documentation du fournisseur.

Remarque :

Si aucune des configurations de cet article ne résout le problème, vérifiez les fichiers ouverts à l’aide de la commande lsof -p. (-p est l’ID de processus du processus problématique.) Il se peut que votre application laisse les fichiers ouverts. Si vous constatez que les mains sont tenues principalement par AEM et non par votre application, contactez le support technique.


<br><br><br><br> <br><br>Augmentation des limites de l’utilisateur<br><br><br><br> <br><br>
Pour modifier le nombre maximal de fichiers ouverts pour les utilisateurs non-root, modifiez le fichier /etc/security/limits.conf. Vous pouvez définir la limite par utilisateur :

crx_process_username soft nofile 8092

crx_process_username hard nofile 20000

Remarque :

Cette configuration ne prend effet que la prochaine fois que l’utilisateur se connecte.


<br><br><br><br> <br><br>Augmentation de la limite du système<br><br><br><br> <br><br>
Parfois, la limite utilisateur est suffisamment élevée, mais le système lui-même a atteint son nombre maximum de fichiers. Exécutez ce qui suit en tant qu’utilisateur su/root :

1. Vérifiez le paramètre d’ouverture de fichier maximal sur le système d’exploitation (s’il est inférieur à 20 000, il est logique d’augmenter ce paramètre).    cat /proc/sys/fs/file-max
2. Ajoutez la ligne suivante à /etc/sysctl.conf pour augmenter la valeur maximale du fichier d’ouverture du système : fs.file-max = 300000
3. Exécutez la commande suivante : sysctl -p
4. Vérifiez que la nouvelle valeur s’affiche lorsque vous exécutez cette commande : cat /proc/sys/fs/file-max


Remarque :

Cette configuration ne prend effet que la prochaine fois que l’utilisateur se connecte.


<br><br><br><br> <br><br>Informations supplémentaires<br><br><br><br> <br><br>
Cette erreur se produit lorsque le système ou l’utilisateur utilise son nombre maximal de fichiers gérés.

TÉLÉCHARGER
[Obtenir le fichier](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh") <br><br>Script Shell que vous pouvez utiliser pour surveiller l’utilisation des fichiers ouverts. N’utilisez ce script que si l’erreur &quot;trop de fichiers ouverts&quot; persiste même après avoir augmenté le maximum. Vous pouvez également l’utiliser si vous pensez que CRX ou votre application laisse les fichiers ouverts. Avant d’utiliser le script, configurez les variables suivantes : JAVA_HOME, QUICKSTART_PATH, OUTPUT_DIR, USER, MAX_FILES_THRESHOLD. Pour utiliser le script, configurez-le comme une tâche cron.
