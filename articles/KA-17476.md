---
title: Comment résoudre les problèmes liés à SAML dans AEM
description: Description
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/21/2021 5:02:47 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 2:33:40 PM
version-number: 1
article-number: KA-17476
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=55a54eb6-9032-ec11-b6e5-000d3a5ba97a
exl-id: f7cf029d-bc42-4180-8746-63b012b7e9ff
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '411'
ht-degree: 1%

---

# Comment résoudre les problèmes liés à SAML dans AEM

## Description

Comment résoudre les problèmes liés à SAML avec AEM ? Quelles informations seraient requises pour résoudre les problèmes ?

## Résolution


<b>Problème de boucle infinie :</b>

- Vérifier si `ds:signature` fait partie de l’assertion SAML Si ce n’est pas le cas, cette opération doit être effectuée du côté IDP et cochez la case pour l’assertion signée.
- Recherchez le format nameId dans la réponse SAML. Le format doit correspondre exactement au format de la stratégie nameId tel que configuré dans la configuration SAML.
- Recherchez SAML AudienceRestriction dans la réponse SAML. La valeur de cette balise doit correspondre exactement à l’ID d’entité dans la configuration SAML.
- Rechercher `saml2:conditions(NotBefore & NotOnOrAfter)`, le serveur n’est pas synchronisé avec le serveur ntp. Utilisez ntpd et forcez-le à synchroniser l’heure système (`ntpdate -s pool.ntp.org`). Pour le test, définissez la tolérance de l’horloge sur -1, ce qui ignorera la différence de l’horloge.
- Vérifiez si IDP n’a pas d’assertion signée. Demandez à l’équipe IDP que la réponse est signée et que l’assertion doit être signée conformément aux spécifications SAML.
- Vérifiez si la sortie du traceur SAML est chiffrée. Si oui, la configuration du gestionnaire d’authentification SAML doit utiliser la case à cocher de chiffrement.


<b>Vérifiez si le certificat SAML est au bon format :</b>

- Récupérez la signature à partir de la réponse SAML et corrigez le certificat, c’est-à-dire après la 65e ligne, appuyez sur Entrée, etc.
- Vous pouvez ensuite l’utiliser pour effectuer l’installation dans AEM TrustStore et faire correspondre les détails du certificat avec IDP.


<b>Chiffrement:</b>

- Commencez toujours par effectuer la configuration SAML sans chiffrement. Lorsque cela est fait, activez le chiffrement. Il est ainsi facile de déboguer le problème.


<b>Dispatcher:</b>

- Assurez-vous que la demande de connexion SAML est autorisée dans la section des filtres. Si ce n’est pas le cas, mettez à jour la `/filter` pour autoriser les requêtes de POST à `\*/saml_login`.



   `/0100 { /type "allow" /method "POST" /url "\*/saml_login" }`


- Vérifier la modification `Mod` header(`mod_header`) au niveau du serveur web dans `httpd.conf`.Il doit être au format inférieur.

   `Header always edit Set-Cookie (.\*) "$1; HTTPOnly; Secure"`


<b>Assertion non valide :</b>
<br><br><br><br><br> <br><br> <br><br><br><br>

| 1<br>  2 | `com.adobe.granite.auth.saml.model.Assertion Invalid Assertion: Signature invalid.` `com.adobe.granite.auth.saml.SamlAuthenticationHandler Private key of SP not provided: Cannot sign Authn request` |
| --- | --- |


- Le problème peut être lié au certificat stocké dans le TrustStore. La solution ici pourrait être de supprimer et de charger à nouveau le nouveau `idp_cert` et vérifiez le cas d’utilisation.
- Si vous ne chiffrez pas la réponse SAML, vous pouvez ignorer &quot;Clé privée du SP non fournie : Impossible de signer l’erreur &quot;Requête d’auteur&quot;.


<b>Impossible de récupérer la clé privée :</b>
<br><br><br><br><br> <br><br> <br><br><br><br>

| 1<br>  2 | `com.adobe.granite.security.user.internal.servlets.KeyStoreManagingServlet,1121, javax.servlet.Servlet ServiceEvent REGISTERED` `saml.log:27.01.2019 14:16:13.642 *ERROR* qtp275633701-179 com.adobe.granite.auth.saml.SamlAuthenticationHandler KeyStore uninitialized. Cannot retrieve private key to decrypt assertions.` |
| --- | --- |

 
- Cette erreur signifie que IDP a chiffré l’assertion et qu’il n’y a pas de clé privée pour déchiffrer la réponse. Si vous souhaitez chiffrer la réponse, vous devez charger une clé privée valide dans le KeyStore AEM.

<br><br><br><br> <br><br>
<b>Informations à fournir lors de la levée d’un ticket de support lié à SAML :</b>

- Requête SAML
- Réponse SAML
- Configuration SAML
- Journaux DEBUG pour SAML (`com.adobe.granite.auth.saml`)
- `Error.log`
- Fichier HAR1 pour extraire la requête/réponse SAML


1https://help.tenderapp.com/kb/troubleshooting-your-tender-site/generating-an-har-file
